<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Админ-панель</title>
		<link
			rel="apple-touch-icon"
			sizes="180x180"
			href="../www/apple-touch-icon.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="32x32"
			href="../www/favicon-32x32.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="16x16"
			href="../www/favicon-16x16.png"
		/>
		<link rel="manifest" href="../www/site.webmanifest" />
		<link rel="stylesheet" href="styles/styles.css" />
		<link rel="stylesheet" href="styles/toast.css" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
		/>
		<style></style>
	</head>
	<body>
		<div id="header"></div>

		<div class="content">
			<div class="admin-header">
				<h1><i class="fas fa-shield-alt"></i> Админ-панель</h1>
			</div>

			<!-- Секция статистики (сохраняем как есть) -->
			<div class="dashboard-container">
				<div class="stat-card">
					<h3>Всего пользователей</h3>
					<div class="stat-number" id="totalUsers"></div>
					<div class="stat-change" id="usersChange">за последнюю неделю</div>
				</div>

				<div class="stat-card">
					<h3>Прочитанных страниц</h3>
					<div class="stat-number" id="totalPages"></div>
					<div class="stat-average" id="pagesAverage">
						В среднем страниц на пользователя
					</div>
				</div>

				<div class="stat-card">
					<h3>Выполненных шагов</h3>
					<div class="stat-number" id="totalSteps"></div>
					<div class="stat-completion" id="stepsCompletion">
						Завершено % всех начатых проектов
					</div>
				</div>
			</div>

			<!-- Секция смены пароля пользователя -->
			<div class="admin-section">
				<div class="admin-section-header">
					<h2><i class="fas fa-key"></i> Смена пароля пользователя</h2>
					<button id="toggleChangePasswordBtn" class="btn-toggle">
						Сменить пароль <i class="fas fa-chevron-down"></i>
					</button>
				</div>
				<div class="section-body">
					<div id="adminChangePasswordForm" class="slide-form">
						<div class="user-selection">
							<button id="chooseUserBtnExternalCP" class="action-btn">
								<i class="fas fa-user"></i> Выбрать пользователя
							</button>
							<span id="selectedUserLabelCP" class="user-label"
								>Пользователь не выбран</span
							>
							<input type="hidden" id="userSelect" required />
						</div>

						<input
							type="password"
							id="newPassword"
							placeholder="Новый пароль"
							class="admin-input"
							required
						/>
						<input
							type="password"
							id="confirmNewPassword"
							placeholder="Повторите новый пароль"
							class="admin-input"
							required
						/>
						<button
							type="submit"
							id="submitChangePasswordBtn"
							class="action-btn"
							disabled
						>
							<i class="fas fa-check"></i> Сменить пароль
						</button>
					</div>
				</div>
			</div>

			<!-- Секция просмотра прочитанных страниц -->
			<div class="admin-section">
				<div class="admin-section-header">
					<h2>
						<i class="fas fa-book-reader"></i> Просмотр прочитанных страниц
					</h2>
					<button id="togglePageReadsBtn" class="btn-toggle">
						Просмотр логов <i class="fas fa-chevron-down"></i>
					</button>
				</div>
				<div class="section-body">
					<div id="adminPageReadsForm" class="slide-form">
						<div class="user-selection">
							<button id="chooseUserBtnExternalPR" class="action-btn">
								<i class="fas fa-user"></i> Выбрать пользователя
							</button>
							<span id="selectedUserLabelPR" class="user-label"
								>Пользователь не выбран</span
							>
							<input type="hidden" id="userSelectReads" required />
						</div>

						<button
							type="button"
							id="loadPageReadsBtn"
							class="action-btn"
							disabled
						>
							<i class="fas fa-sync-alt"></i> Загрузить лог чтения
						</button>
						<div id="pageReadsTableContainer"></div>
					</div>
				</div>
			</div>
			<!-- Добавьте эту секцию после секции просмотра прочитанных страниц -->
			<div class="admin-section">
				<div class="admin-section-header">
					<h2><i class="fas fa-users"></i> Пользователи онлайн</h2>
					<button id="toggleOnlineUsersBtn" class="btn-toggle">
						Показать онлайн <i class="fas fa-chevron-down"></i>
					</button>
				</div>
				<div class="section-body">
					<div id="adminOnlineUsersForm" class="slide-form">
						<div class="online-controls">
							<button type="button" id="loadOnlineUsersBtn" class="action-btn">
								<i class="fas fa-sync-alt"></i> Обновить список
							</button>
							<div class="online-count">
								<i class="fas fa-circle" style="color: #4caf50"></i>
								<span id="onlineUsersCount">0</span> пользователей онлайн
							</div>
						</div>
						<div id="onlineUsersContainer" class="online-users-grid"></div>
					</div>
				</div>
			</div>
		</div>

		<!-- Модальное окно выбора пользователя -->
		<div id="userSelectionModal" class="modal">
			<div class="modal-content">
				<h2><i class="fas fa-users"></i> Выбор пользователя</h2>
				<div class="modal-search">
					<input
						type="text"
						id="userSearchInput"
						class="admin-input"
						placeholder="Введите имя или логин пользователя"
					/>
					<button id="searchUserBtn" class="action-btn">
						<i class="fas fa-search"></i> Найти
					</button>
				</div>

				<select id="userList" class="user-select" size="5"></select>

				<div class="modal-actions">
					<button id="closeUserModal" class="btn-toggle">Закрыть</button>
					<button id="applyUserBtn" class="action-btn">Применить</button>
				</div>
			</div>
		</div>

		<!-- Скрипты -->
		<script src="scripts/config.js"></script>
		<script src="scripts/heartbeat.js"></script>
		<script src="scripts/admin-online-users.js"></script>
		<script src="scripts/theme-change.js"></script>
		<script src="scripts/header-loader.js"></script>
		<script src="scripts/toast.js"></script>
		<script src="scripts/admin-dashboard.js"></script>
		<script src="scripts/admin-user-modal.js"></script>
		<script src="scripts/admin-changepassword.js"></script>
		<script src="scripts/admin-page-reads.js"></script>
		<script>
			// Скрипт для слайд-форм
			document.addEventListener('DOMContentLoaded', function () {
				const toggleChangePasswordBtn = document.getElementById(
					'toggleChangePasswordBtn'
				)
				const togglePageReadsBtn = document.getElementById('togglePageReadsBtn')
				const changePasswordForm = document.getElementById(
					'adminChangePasswordForm'
				)
				const pageReadsForm = document.getElementById('adminPageReadsForm')
				const toggleOnlineUsersBtn = document.getElementById(
					'toggleOnlineUsersBtn'
				)
				const onlineUsersForm = document.getElementById('adminOnlineUsersForm')

				toggleOnlineUsersBtn.addEventListener('click', function () {
					onlineUsersForm.classList.toggle('active')
					this.classList.toggle('active')

					if (this.classList.contains('active')) {
						this.innerHTML = 'Скрыть онлайн <i class="fas fa-chevron-up"></i>'
						// Загружаем данные при открытии
						loadOnlineUsers()
					} else {
						this.innerHTML =
							'Показать онлайн <i class="fas fa-chevron-down"></i>'
					}
				})
				toggleChangePasswordBtn.addEventListener('click', function () {
					changePasswordForm.classList.toggle('active')
					this.classList.toggle('active')

					if (this.classList.contains('active')) {
						this.innerHTML = 'Скрыть форму <i class="fas fa-chevron-down"></i>'
					} else {
						this.innerHTML =
							'Сменить пароль <i class="fas fa-chevron-down"></i>'
					}
				})

				togglePageReadsBtn.addEventListener('click', function () {
					pageReadsForm.classList.toggle('active')
					this.classList.toggle('active')

					if (this.classList.contains('active')) {
						this.innerHTML = 'Скрыть логи <i class="fas fa-chevron-down"></i>'
					} else {
						this.innerHTML =
							'Просмотр логов <i class="fas fa-chevron-down"></i>'
					}
				})

				// Активируем кнопки при выборе пользователя
				const userSelect = document.getElementById('userSelect')
				const userSelectReads = document.getElementById('userSelectReads')
				const submitChangePasswordBtn = document.getElementById(
					'submitChangePasswordBtn'
				)
				const loadPageReadsBtn = document.getElementById('loadPageReadsBtn')

				// Наблюдатель изменений для поля выбора пользователя
				const observeUserField = function (field, button) {
					const observer = new MutationObserver(function (mutations) {
						button.disabled = !field.value
					})

					observer.observe(field, { attributes: true })
				}

				observeUserField(userSelect, submitChangePasswordBtn)
				observeUserField(userSelectReads, loadPageReadsBtn)

				// Приветствие администратора
				const welcomeMessage = document.getElementById('welcomeMessage')
				if (welcomeMessage) {
					const token = localStorage.getItem('token')
					if (token) {
						try {
							const payload = JSON.parse(atob(token.split('.')[1]))
							const name = payload.name || 'Администратор'
							welcomeMessage.innerHTML = `<i class="fas fa-user-circle"></i> Добро пожаловать, <strong>${name}</strong>!`
						} catch (e) {
							console.error('Ошибка при декодировании токена:', e)
						}
					}
				}
			})
		</script>
	</body>
</html>
